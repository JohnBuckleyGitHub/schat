var Profile={addRow:function(a,b){$("#profile-table").append(Utils.row("field-"+a,b))},feed:function(a){"body"===a.type&&a.feed===FEED_NAME_PROFILE&&a.id===Settings.getId()&&Profile.read(a.data,a.status)},read:function(a,b){if(Loader.spinner.prepare(FEED_NAME_PROFILE,b)&&a!==!1){a.hasOwnProperty("provider")?$("#user-account").html('<a href="'+a.link+'"><i class="provider-'+a.provider+'"></i></a>'):Profile.setAnonymous(),$("#profile-table *").remove();var c="field-gender-"+Profile.gender(SimpleChat.channel(Settings.getId()).Gender);Profile.addRow("gender",'<span data-tr="'+c+'">'+Utils.tr(c)+"</span>");for(var d=SimpleChat.fields(),e=0;e<d.length;e++){var f=d[e];if(a.hasOwnProperty(f)){var g=a[f];if("string"!=typeof g||""!==g)try{Profile.Field[f](f,g)}catch(h){}}}Profile.retranslate()}},gender:function(a){switch(a){case 0:return"male";case 100:return"female";case 151:return"ghost";case 152:return"bot";default:return"unknown"}},reload:function(){1==Pages.current&&(Utils.TR("profile"),Profile.read(SimpleChat.feed(Settings.getId(),FEED_NAME_PROFILE,3),302),SimpleChat.feed(Settings.getId(),FEED_NAME_PROFILE,1),Profile.setStatus())},retranslate:function(){Utils.adjustWidth($("#profile-table .field-row-label"))},Field:{name:function(a,b){Profile.addRow(a,Utils.left(htmlspecialchars(Utils.simplified(b)),128))}},setAnonymous:function(){$("#user-account").html('<span data-tr="anonymous_user">'+Utils.tr("anonymous_user")+"</span>")},updateStatus:function(a,b){Settings.id==a&&Settings.status!=b&&(Settings.status=b,$("#user-status-text").attr("data-tr","status_"+b),$("#user-status-text").text(Utils.tr("status_"+b)))},setStatus:function(){Profile.updateStatus(Settings.id,SimpleChat.status(Settings.id))},offline:function(){Profile.updateStatus(Settings.id,"Offline")}},Connections={feed:function(a){"body"===a.type&&a.feed===FEED_NAME_USER&&a.id==Settings.getId()&&Connections.read(a.data,a.status)},process:function(a,b){$("#connections").append('<div class="connection-row bottom-line" id="'+a+'">'+'<i title="'+htmlspecialchars(b.osName)+'" class="icon-os os-'+Pages.os(b.os)+'"></i> '+'<a href="#" class="connection-host modal-toggle" data-handler="connection">'+b.host+"</a>"+"</div>"),$("#"+a+" > .connection-host").data("id",a);for(var c=0;c<UserHooks.process.length;c++)UserHooks.process[c](a,b)},read:function(a,b){if(Loader.spinner.prepare(FEED_NAME_USER,b)&&a!==!1){$(".connection-row").remove(),a.hasOwnProperty("provider")||Profile.setAnonymous();var c=a.connections,d=0;for(var e in c)c.hasOwnProperty(e)&&34==e.length&&(d++,Connections.process(e,c[e]));d>0?$("#user-offline").hide():Connections.offline()}},reload:function(){1==Pages.current&&("Offline"!=SimpleChat.status(Settings.getId())?Connections.online():Connections.offline(),Utils.retranslate())},offline:function(){var a=SimpleChat.mdate(Settings.getId(),FEED_NAME_USER),b=$("#user-offline");if($(".connection-row").remove(),a&&SimpleChat.isOnline()){b.removeAttr("data-tr");var c=100==SimpleChat.channel(Settings.getId()).Gender?"was_online_f":"was_online_m",d='<div id="offline-since"><span data-tr="'+c+'">'+Utils.tr(c)+"</span> ",e=SimpleChat.feed(Settings.getId(),FEED_NAME_USER,3);d+=e!==!1&&e.hasOwnProperty("last")?'<a href="#" class="modal-toggle timeago" data-handler="connection" title="'+a+'">'+DateTime.template(a,!0)+"</a>":'<span class="timeago" title="'+a+'">'+DateTime.template(a,!0)+"</span>",b.html(d+"</div>"),Connections.retranslate()}else b.attr("data-tr","user_offline"),b.html(Utils.tr("user_offline"));b.show(),Loader.spinner.remove("loading/user"),a||SimpleChat.feed(Settings.getId(),FEED_NAME_USER,1)},online:function(){Connections.read(SimpleChat.feed(Settings.getId(),FEED_NAME_USER,3),302),SimpleChat.feed(Settings.getId(),FEED_NAME_USER,1)},retranslate:function(){Loader.loadJS("qrc:/js/jquery.timeago."+Utils.tr("lang")+".js",function(){$(".timeago").timeago()})}},UserHooks={process:[],connection:[]};Modal.create.connection=function(a){var b=$("#modal-header h3");b.text(a.target.innerText);var c=SimpleChat.feed(Settings.id,FEED_NAME_USER,3);if(c===!1||!c.hasOwnProperty("connections"))return!1;var d=$(a.target).data("id"),e="undefined"==typeof d?c.last:c.connections[d];if("undefined"==typeof e)return!1;var f=$("#modal-body");b.text(e.host),f.append(Utils.row("chat_version",htmlspecialchars(e.version))),f.append(Utils.row("os_name",'<i class="icon-os os-'+Pages.os(e.os)+'"></i> '+htmlspecialchars(e.osName)));for(var g=0;g<UserHooks.connection.length;g++)UserHooks.connection[g](e);return!0},Modal.shown.connection=function(){Utils.adjustWidth($("#modal-body .field-row-label"))},Pages.onInfo.push(Profile.reload),Pages.onInfo.push(Connections.reload),"undefined"!=typeof ChatView&&(ChatView.feed.connect(Profile.feed),ChatView.reload.connect(Profile.reload),SimpleChat.retranslated.connect(Profile.retranslate),SimpleChat.retranslated.connect(Connections.retranslate),SimpleChat.statusChanged.connect(Profile.updateStatus),SimpleChat.offline.connect(Profile.offline),SimpleChat.offline.connect(Connections.offline),SimpleChat.online.connect(Connections.online),ChatView.feed.connect(Connections.feed),ChatView.reload.connect(Connections.reload));