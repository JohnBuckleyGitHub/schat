function HistoryScroll(a,b){this.id="",this.messages={},this.count=0,"since"==a&&b.hasOwnProperty("day")?this.id="day-"+b.day:"last"==a&&b.user===!0&&(this.id="Chat");for(var c=0;c<b.messages.length;c++){var d=b.messages[c];null===document.getElementById(d)&&-1==History.unhandled.indexOf(d)&&this.messages[d]!==!0&&(this.messages[d]=!0,this.count++)}0==this.count?(History.done(),History.unhandled=[],""!=this.id&&(Settings.scrollTo=this.id)):History.scroll=this,this.removeAll=function(a){for(var b=0;b<a.length;b++)this.messages.hasOwnProperty(a[b])&&(delete this.messages[a[b]],this.count--);0==this.count&&(History.scroll=null,History.unhandled=[],History.done(),""!=this.id&&(Settings.scrollTo=this.id))}}var History={date:0,message:null,scroll:null,top:!1,unhandled:[],show:function(){if(null===document.getElementById("history")){var a=document.getElementById("Chat"),b=document.createElement("div");b.id="history-bar",b.innerHTML='<div id="history"></div>',a.insertBefore(b,a.firstChild)}document.getElementById("history-bar").style.display="block"},hide:function(){$("#history-bar").hide(),alignChat(),Loader.spinner.remove("history_loading")},click:function(a){a.preventDefault(),SimpleChat.isOnline()&&(History.loading(Settings.id),SimpleChat.get(Settings.id,"messages/last",{before:History.date,user:!0}))},loading:function(a){Settings.id==a&&Loader.spinner.add("history_loading")},feed:function(a){a.id==Settings.getId()&&"reply"==a.type&&"get"==a.cmd&&("messages/last"==a.name?History.last(a):"messages/since"==a.name&&History.since(a))},last:function(a){if(History.date=0,History.message=null,200==a.status&&a.data.messages.length){var b=a.data.messages[0];$("#"+b).length?History.date=$("#"+b).attr("data-time"):History.message=b,a.data.count<20&&(History.top=!0),alignChat(),new HistoryScroll("last",a.data)}else 303!=a.status&&History.hide()},since:function(a){200==a.status&&a.data.messages.length?new HistoryScroll("since",a.data):History.done()},done:function(){var a=document.getElementById("history-bar");History.top?null!==a&&(a.style.display="none"):(History.show(),document.getElementById("history").innerHTML='<a class="history-more btn btn-small" href="#"><i class="icon-history-more"></i> <span data-tr="history_more">'+Utils.tr("history_more")+"</span></a>"),alignChat(),Loader.spinner.remove("history_loading")},onAdd:function(){},onBulkAdd:function(a){for(var b=0;b<a.length;b++)null!==History.message&&History.message==a[b]&&(History.date=document.getElementById(a[b]).getAttribute("data-time"),History.message=null);History.scroll instanceof HistoryScroll&&History.scroll.removeAll(a)},count:function(a){if(null!==document.getElementById(a)){var b=$("#"+a).attr("data-time");if(void 0!==b){var c=DateTime.dayId(new Date(parseInt(b)));if(10==c.length&&null!==document.getElementById("day-"+c)&&!$("#day-"+c+" .day-header").hasClass("expanded")){var d=$("#day-"+c+" .day-badge"),e=parseInt(d.text());e++,d.text(e),1==e&&d.fadeIn("fast")}}}},unhandledMessage:function(a){var b=a.OID||a.Id;if(History.scroll instanceof HistoryScroll){var c=[b];History.scroll.removeAll(c)}else-1==History.unhandled.indexOf(b)&&History.unhandled.push(b)},reload:function(){History.message=null,History.date=0,History.top=!0,History.done(),History.top=!1}};"undefined"==typeof HistoryView?HistoryView={isAutoLoad:function(){return!0}}:(HistoryView.loading.connect(History.loading),ChatView.feed.connect(History.feed),ChatView.reload.connect(History.reload)),Messages.onAdd.push(History.onAdd),Messages.onBulkAdd.push(History.onBulkAdd),Messages.unhandled.push(History.unhandledMessage),$(document).ready(function(){$("body").on("click.history","#history a",History.click),SimpleChat.isOnline()?HistoryView.isAutoLoad(Settings.getId())&&History.loading(Settings.id):History.done()});