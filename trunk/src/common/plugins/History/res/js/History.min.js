function HistoryScroll(b,c){this.id="Chat";this.messages=[];if(b=="since"){this.id="day-"+c.day}for(var a=0;a<c.messages.length;a++){if(document.getElementById(c.messages[a])===null){this.messages.push(c.messages[a])}}if(this.messages.length){History.scroll=this}else{document.getElementById(this.id).scrollIntoView()}this.remove=function(e){var d=this.messages.indexOf(e);if(d!=-1){this.messages.splice(d,1);if(!this.messages.length){History.scroll=null;Settings.scrollTo=this.id}}}}var History={date:0,message:"",scroll:null,show:function(){if(!$("#history").length){$("#Chat").prepend('<div id="history-bar" class="history-bar"><div class="history-bar-inner"><div id="history"></div></div></div>')}$(".history-bar").show()},hide:function(){$(".history-bar").hide()},click:function(a){a.preventDefault();History.loading(Settings.id);SimpleChat.get(Settings.id,"messages/last",{before:History.date,user:true})},loading:function(a){if(Settings.id!=a){return}History.show();$("#history").html('<i class="icon-spinner-small"></i> <span data-tr="history_loading">'+Utils.tr("history_loading")+"</span>");alignChat()},feed:function(a){if(a.id!=Settings.getId()){return}if(a.type=="reply"&&a.cmd=="get"){if(a.name=="messages/last"){History.last(a)}else{if(a.name=="messages/since"){History.since(a)}}}},last:function(a){History.date=0;History.message="";if(a.status==200&&a.data.messages.length){var b=a.data.messages[0];if($("#"+b).length){History.date=$("#"+b).attr("data-time")}else{History.message=b}if(a.data.count<20){History.hide()}else{History.done()}if(a.data.user===true){new HistoryScroll("last",a.data)}}else{History.hide();alignChat()}},since:function(a){History.done();if(a.data.hasOwnProperty("day")){new HistoryScroll("since",a.data)}},done:function(){$("#history").html('<a class="history-more" href="#" data-tr="history_more">'+Utils.tr("history_more")+"</a>")},onAdd:function(a){if(History.message!=""&&History.message==a){History.date=$("#"+a).attr("data-time");History.message="";if(History.date){History.done()}}if(History.scroll instanceof HistoryScroll){History.scroll.remove(a)}},reload:function(){History.message="";History.date=0;History.done();History.show();alignChat()}};if(typeof HistoryView==="undefined"){HistoryView={}}else{HistoryView.loading.connect(History.loading);ChatView.feed.connect(History.feed);ChatView.reload.connect(History.reload)}Messages.onAdd.push(History.onAdd);$(document).ready(function(){$("body").on("click.history","#history a",History.click);History.loading(Settings.id)});