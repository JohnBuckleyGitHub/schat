$(document).ready(function(){$("body").on("click.history","#history a",History.click);History.loading(Settings.id)});var History={date:0,message:"",show:function(){if(!$("#history").length){$("#Chat").prepend('<div id="history-bar" class="history-bar"><div class="history-bar-inner"><div id="history"></div></div></div>')}$(".history-bar").show();alignChat()},hide:function(){$(".history-bar").hide();alignChat()},click:function(a){a.preventDefault();if(!History.date){return}History.loading(Settings.id);SimpleChat.get(Settings.id,"messages/last",{before:History.date})},loading:function(a){if(Settings.id!=a){return}History.show();$("#history").html('<i class="icon-spinner-small"></i> <span data-tr="history_loading">'+Utils.tr("history_loading")+"</span>");alignChat()},feed:function(a){if(a.id!=Settings.getId()){return}if(a.type=="reply"&&a.cmd=="get"&&a.name=="messages/last"){History.last(a)}},last:function(a){History.date=0;History.message="";if(a.status==200&&a.data.messages.length){var b=a.data.messages[0];if($("#"+b).length){History.date=$("#"+b).attr("data-time");History.done()}else{History.message=b}}else{History.hide()}},done:function(){$("#history").html('<a class="history-more" href="#" data-tr="history_more">'+Utils.tr("history_more")+"</a>")},onAdd:function(a){if(History.message!=""&&History.message==a){History.date=$("#"+a).attr("data-time");History.message="";if(History.date){History.done()}}}};if(typeof HistoryView==="undefined"){HistoryView={}}else{HistoryView.loading.connect(History.loading);ChatView.feed.connect(History.feed)}Messages.onAdd.push(History.onAdd);