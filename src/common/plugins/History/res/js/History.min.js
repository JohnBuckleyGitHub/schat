function HistoryScroll(b,c){this.id="";this.messages=[];if(b=="since"&&c.hasOwnProperty("day")){this.id="day-"+c.day}else{if(b=="last"&&c.user===true){this.id="Chat"}}for(var a=0;a<c.messages.length;a++){if(document.getElementById(c.messages[a])===null){this.messages.push(c.messages[a])}}if(!this.messages.length){History.done();if(this.id!=""){Settings.scrollTo=this.id;document.getElementById(this.id).scrollIntoView()}}else{History.scroll=this}this.remove=function(e){var d=this.messages.indexOf(e);if(d!=-1){this.messages.splice(d,1);if(!this.messages.length){History.scroll=null;History.done();if(this.id!=""){Settings.scrollTo=this.id}}}}}var History={date:0,message:null,scroll:null,top:false,show:function(){if(!$("#history").length){$("#Chat").prepend('<div id="history-bar"><div id="history"></div></div>')}$("#history-bar").show()},hide:function(){$("#history-bar").hide();alignChat();Loader.spinner.remove("history_loading")},click:function(a){a.preventDefault();History.loading(Settings.id);SimpleChat.get(Settings.id,"messages/last",{before:History.date,user:true})},loading:function(a){if(Settings.id!=a){return}Loader.spinner.add("history_loading")},feed:function(a){if(a.id!=Settings.getId()){return}if(a.type=="reply"&&a.cmd=="get"){if(a.name=="messages/last"){History.last(a)}else{if(a.name=="messages/since"){History.since(a)}}}},last:function(a){History.date=0;History.message=null;if(a.status==200&&a.data.messages.length){var b=a.data.messages[0];if($("#"+b).length){History.date=$("#"+b).attr("data-time")}else{History.message=b}if(a.data.count<20){History.top=true}alignChat();new HistoryScroll("last",a.data)}else{History.hide()}},since:function(a){if(a.status==200&&a.data.messages.length){new HistoryScroll("since",a.data)}else{History.done()}},done:function(){if(!History.top){History.show();$("#history").html('<a class="history-more btn btn-small" href="#"><i class="icon-history-more"></i> <span data-tr="history_more">'+Utils.tr("history_more")+"</span></a>")}else{$("#history-bar").hide()}alignChat();Loader.spinner.remove("history_loading")},onAdd:function(a){if(History.message!==null&&History.message==a){History.date=$("#"+a).attr("data-time");History.message=null}if(History.scroll instanceof HistoryScroll){History.scroll.remove(a)}},reload:function(){History.message=null;History.date=0;History.top=false;History.done();alignChat()}};if(typeof HistoryView==="undefined"){HistoryView={}}else{HistoryView.loading.connect(History.loading);ChatView.feed.connect(History.feed);ChatView.reload.connect(History.reload)}Messages.onAdd.push(History.onAdd);$(document).ready(function(){$("body").on("click.history","#history a",History.click);History.loading(Settings.id)});