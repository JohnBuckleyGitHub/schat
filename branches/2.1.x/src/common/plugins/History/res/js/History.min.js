function HistoryScroll(b,c){this.id="";this.messages={};this.count=0;if(b=="since"&&c.hasOwnProperty("day")){this.id="day-"+c.day}else{if(b=="last"&&c.user===true){this.id="Chat"}}for(var a=0;a<c.messages.length;a++){var d=c.messages[a];if(document.getElementById(d)===null&&History.unhandled.indexOf(d)==-1&&this.messages[d]!==true){this.messages[d]=true;this.count++}}if(this.count==0){History.done();History.unhandled=[];if(this.id!=""){Settings.scrollTo=this.id}}else{History.scroll=this}this.removeAll=function(f){for(var e=0;e<f.length;e++){if(this.messages.hasOwnProperty(f[e])){delete this.messages[f[e]];this.count--}}if(this.count==0){History.scroll=null;History.unhandled=[];History.done();if(this.id!=""){Settings.scrollTo=this.id}}}}var History={date:0,message:null,scroll:null,top:false,unhandled:[],show:function(){if(document.getElementById("history")===null){var a=document.getElementById("Chat");var b=document.createElement("div");b.id="history-bar";b.innerHTML='<div id="history"></div>';a.insertBefore(b,a.firstChild)}document.getElementById("history-bar").style.display="block"},hide:function(){$("#history-bar").hide();alignChat();Loader.spinner.remove("history_loading")},click:function(a){a.preventDefault();if(!SimpleChat.isOnline()){return}History.loading(Settings.id);SimpleChat.get(Settings.id,"messages/last",{before:History.date,user:true})},loading:function(a){if(Settings.id!=a){return}Loader.spinner.add("history_loading")},feed:function(a){if(a.id!=Settings.getId()){return}if(a.type=="reply"&&a.cmd=="get"){if(a.name=="messages/last"){History.last(a)}else{if(a.name=="messages/since"){History.since(a)}}}},last:function(a){History.date=0;History.message=null;if(a.status==200&&a.data.messages.length){var b=a.data.messages[0];if($("#"+b).length){History.date=$("#"+b).attr("data-time")}else{History.message=b}if(a.data.count<20){History.top=true}alignChat();new HistoryScroll("last",a.data)}else{if(a.status!=303){History.hide()}}},since:function(a){if(a.status==200&&a.data.messages.length){new HistoryScroll("since",a.data)}else{History.done()}},done:function(){var a=document.getElementById("history-bar");if(!History.top){History.show();document.getElementById("history").innerHTML='<a class="history-more btn btn-small" href="#"><i class="icon-history-more"></i> <span data-tr="history_more">'+Utils.tr("history_more")+"</span></a>"}else{if(a!==null){a.style.display="none"}}alignChat();Loader.spinner.remove("history_loading")},onAdd:function(a){},onBulkAdd:function(b){for(var a=0;a<b.length;a++){if(History.message!==null&&History.message==b[a]){History.date=document.getElementById(b[a]).getAttribute("data-time");History.message=null}}if(History.scroll instanceof HistoryScroll){History.scroll.removeAll(b)}},count:function(e){if(document.getElementById(e)===null){return}var d=$("#"+e).attr("data-time");if(d===undefined){return}var b=DateTime.dayId(new Date(parseInt(d)));if(b.length!=10){return}if(document.getElementById("day-"+b)===null){return}if($("#day-"+b+" .day-header").hasClass("expanded")){return}var a=$("#day-"+b+" .day-badge");var c=parseInt(a.text());c++;a.text(c);if(c==1){a.fadeIn("fast")}},unhandledMessage:function(a){var c=a.OID||a.Id;if(History.scroll instanceof HistoryScroll){var b=[c];History.scroll.removeAll(b)}else{if(History.unhandled.indexOf(c)==-1){History.unhandled.push(c)}}},reload:function(){History.message=null;History.date=0;History.top=true;History.done();History.top=false}};if(typeof HistoryView==="undefined"){HistoryView={isAutoLoad:function(a){return true}}}else{HistoryView.loading.connect(History.loading);ChatView.feed.connect(History.feed);ChatView.reload.connect(History.reload)}Messages.onAdd.push(History.onAdd);Messages.onBulkAdd.push(History.onBulkAdd);Messages.unhandled.push(History.unhandledMessage);$(document).ready(function(){$("body").on("click.history","#history a",History.click);if(SimpleChat.isOnline()){if(HistoryView.isAutoLoad(Settings.getId())){History.loading(Settings.id)}}else{History.done()}});